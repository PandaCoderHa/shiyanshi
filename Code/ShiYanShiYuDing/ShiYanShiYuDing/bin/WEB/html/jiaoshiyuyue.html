<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="utf-8" />
    <title>高校实验室预约系统</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="../libs/assets/animate.css/animate.css" type="text/css" />
    <link rel="stylesheet" href="../libs/assets/font-awesome/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../libs/assets/simple-line-icons/css/simple-line-icons.css" type="text/css" />
    <link rel="stylesheet" href="../libs/jquery/bootstrap/dist/css/bootstrap.css" type="text/css" />

    <link rel="stylesheet" href="css/font.css" type="text/css" />
    <link rel="stylesheet" href="css/app.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <link rel="stylesheet" href="css/jquery.seat-charts.css" type="text/css" />

    <link href="css/site.css" rel="stylesheet" type="text/css" />
    <link href="css/detail.css" rel="stylesheet" type="text/css" />

</head>

<body>
    <header id="header" class="app-header navbar" role="menu">
        <!-- navbar header -->
        <div class="navbar-header bg-dark">
            <button class="pull-right visible-xs dk" ui-toggle-class="show" target=".navbar-collapse">
                <i class="glyphicon glyphicon-cog"></i>
            </button>
            <button class="pull-right visible-xs" ui-toggle-class="off-screen" target=".app-aside" ui-scroll="app">
                <i class="glyphicon glyphicon-align-justify"></i>
            </button>
            <!-- brand -->
            <a href="home.html" class="navbar-brand text-lt">

                <span class="hidden-folded m-l-xs">高校实验室预约系统</span>
            </a>
            <!-- / brand -->
        </div>





        <div class="collapse pos-rlt navbar-collapse box-shadow bg-white-only">



            <ul class="nav navbar-nav navbar-right">

                <li class="dropdown">
                    <a href="#" data-toggle="dropdown" class="dropdown-toggle clear">
                        <span class="thumb-sm avatar pull-right m-t-n-sm m-b-n-sm m-l-sm">
                            <img src="img/b6.jpg" alt="...">
                            <i class="on md b-white bottom"></i>
                        </span>
                        <span id="userName" class="hidden-sm hidden-md">胡司令</span>
                        <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu animated fadeInRight w">
                        <li>
                            <a id="logout" ui-sref="access.signin">退出登录</a>
                        </li>
                    </ul>
                    <!-- / dropdown -->
                </li>
            </ul>

            <ul class="nav navbar-nav navbar-right mr20">

                <li class="dropdown">
                    <a href="#" data-toggle="dropdown" class="dropdown-toggle" aria-expanded="false">
                        <i class="fa fa-fw fa-plus visible-xs-inline-block"></i>
                        <span translate="header.navbar.new.NEW">管理员设置</span>
                        <span class="caret"></span>
                    </a>
                    <ul id="manager" class="dropdown-menu" role="menu">
                    </ul>
                </li>

                <li class="dropdown">
                    <a href="#" data-toggle="dropdown" class="dropdown-toggle" aria-expanded="false">
                        <i class="fa fa-fw fa-plus visible-xs-inline-block"></i>
                        <span translate="header.navbar.new.NEW">个人中心</span>
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="yuyue-manager.html">预约管理</a>
                        </li>
                        <li>
                            <a href="info-change.html">修改个人资料</a>
                        </li>
                    </ul>
                </li>

            </ul>



            <!-- / navbar right -->
        </div>
        <!-- / navbar collapse -->
    </header>

    <banner>
        <div class="banner-img"></div>
    </banner>

    <div class="app app-header-fixed ">
        <div class="g-in f-cb">

            <div class="g-sd-l">
                <div class="m-s-menu">
                    <ul>
                        <li class="learn">
                            <span class="fa fa-th-list"></span> 实验室列表</li>
                    </ul>
                </div>
            </div>

            <div class="g-mncw w860">
                <form>



                    <div class="m-school">
                        <div class="part">

                            <div class="part-info">
                                <i class="glyphicon glyphicon-info-sign"></i>
                                <label>当日开放：</label>
                                <span>08:00 - 22:00</span>
                                <i>；</i>
                                <label>当日不可用：</label>
                                <span id="bukeyong">08:00 - 22:00</span>
                                <i>；</i>
                                <label>预约至少提前：</label>
                                <span>0天</span>
                                <i>；</i>
                                <label>最长提前：</label>
                                <span>10天</span>
                                <i>；</i>
                                <label>允许时长</label>
                                <span>1小时 － 4小时</span>
                                <i>；</i>
                                <label>迟到</label>
                                <span>30分钟</span>取消预约。
                            </div>

                            <div class="tit">
                                <span class="u-tt-md">申请人信息</span>
                            </div>
                            <div class="name-info">
                                <label>学号：</label>
                                <span id="user">0000001</span>
                                <label>姓名：</label>
                                <span id="name">胡司令</span>
                                <label>实验室：</label>
                                <span id="shiyanshi">第一实验室</span>
                            </div>
                        </div>
                        <div class="part dates">


                            <div class="tit">
                                <span class="u-tt-md">日期</span>
                            </div>
                            <!-- <div class="tit2">显示一个星期内的</div> -->
                            <ul id="checkDate">
                                <li class="active">
                                    <span id="riqi" class="day">10-15</span>
                                    <span id="riqizhou" class="week">周日</span>
                                </li>
                                <!-- <li>
                  <span class="day">10-13</span>
                  <span class="week">今天</span>
                </li>
                <li>
                  <span class="day">10-14</span>
                  <span class="week">明天</span>
                </li>
                <li class="active">
                  <span class="day">10-15</span>
                  <span class="week">周日</span>
                </li>
                <li>
                  <span class="day">10-16</span>
                  <span class="week">周一</span>
                </li>
                <li>
                  <span class="day">10-17</span>
                  <span class="week">周二</span>
                </li>
                <li>
                  <span class="day">10-18</span>
                  <span class="week">周三</span>
                </li>
                <li>
                  <span class="day">10-19</span>
                  <span class="week">周四</span>
                </li> -->
                            </ul>
                        </div>


                        <div class="part time">

                            <div class="tit">
                                <span class="u-tt-md">选择时间段</span>
                            </div>

                            <div class="select-time">
                                <select id="kaishi" class="form-control m-b">
                                    <option valuue="08:00">08:00</option>
                                    <option valuue="08:30">08:30</option>
                                    <option valuue="09:00">09:00</option>
                                    <option valuue="09:30">09:30</option>
                                    <option valuue="10:00">10:00</option>
                                    <option valuue="10:30">10:30</option>
                                    <option valuue="11:00">11:00</option>
                                    <option valuue="11:30">11:30</option>
                                    <option valuue="12:00">12:00</option>
                                    <option valuue="12:30">12:30</option>
                                    <option valuue="13:00">13:00</option>
                                    <option valuue="13:30">13:30</option>
                                    <option valuue="14:00">14:00</option>
                                    <option valuue="14:30">14:30</option>
                                    <option valuue="15:00">15:00</option>
                                    <option valuue="15:30">15:30</option>
                                    <option valuue="16:00">16:00</option>
                                    <option valuue="16:30">16:30</option>
                                    <option valuue="17:00">17:00</option>
                                    <option valuue="17:30">17:30</option>
                                    <option valuue="18:00">18:00</option>
                                    <option valuue="18:30">18:30</option>
                                    <option valuue="19:00">19:00</option>
                                    <option valuue="19:30">19:30</option>
                                    <option valuue="20:00">20:00</option>
                                    <option valuue="20:30">20:30</option>
                                    <option valuue="21:00">21:00</option>
                                    <option valuue="21:30">21:30</option>
                                    <option valuue="22:00">22:00</option>
                                </select>
                            </div>

                            <span class="toto">–</span>

                            <div class="select-time">
                                <select id="jieshu" class="form-control m-b">
                                    <option valuue="99:99"> </option>
                                    <option valuue="08:00">08:00</option>
                                    <option valuue="08:30">08:30</option>
                                    <option valuue="09:00">09:00</option>
                                    <option valuue="09:30">09:30</option>
                                    <option valuue="10:00">10:00</option>
                                    <option valuue="10:30">10:30</option>
                                    <option valuue="11:00">11:00</option>
                                    <option valuue="11:30">11:30</option>
                                    <option valuue="12:00">12:00</option>
                                    <option valuue="12:30">12:30</option>
                                    <option valuue="13:00">13:00</option>
                                    <option valuue="13:30">13:30</option>
                                    <option valuue="14:00">14:00</option>
                                    <option valuue="14:30">14:30</option>
                                    <option valuue="15:00">15:00</option>
                                    <option valuue="15:30">15:30</option>
                                    <option valuue="16:00">16:00</option>
                                    <option valuue="16:30">16:30</option>
                                    <option valuue="17:00">17:00</option>
                                    <option valuue="17:30">17:30</option>
                                    <option valuue="18:00">18:00</option>
                                    <option valuue="18:30">18:30</option>
                                    <option valuue="19:00">19:00</option>
                                    <option valuue="19:30">19:30</option>
                                    <option valuue="20:00">20:00</option>
                                    <option valuue="20:30">20:30</option>
                                    <option valuue="21:00">21:00</option>
                                    <option valuue="21:30">21:30</option>
                                    <option valuue="22:00">22:00</option>
                                </select>
                            </div>


                        </div>


                        <div class="part time">
                            <div class="tit">
                                <span class="u-tt-md">选择座位</span>
                            </div>
                            <div id="my-legend-container" class="seatCharts-info">
                                <!-- <span class="inblock mlr5">
                                    <i class="seat_ture v_m mr3"></i>可选座位</span>
                                <span class="inblock mlr5">
                                    <i class="seat_selected v_m mr3"></i>已选座位</span>
                                <span class="inblock mlr5">
                                    <i class="seat_false v_m mr3"></i>不可选座位</span> -->
                            </div>


                            <div id="seat-map" class="seatCharts-left-box">
                            </div>

                            <!-- <div class="seatCharts-right-box">
                                <div class="seatCharts-selected">已选中的座位</div>
                                <div class="seatCharts-selected-list">
                                    <span>座位01</span>
                                </div>
                            </div> -->
                        </div>
                        <div class="sibmit f-tac">
                            <input id="tijiao" type="button" value="提交申请" class="u-btn md active jsSubmit">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <script src="../libs/jquery/jquery/dist/jquery.js"></script>
    <script src="../libs/jquery/bootstrap/dist/js/bootstrap.js"></script>
    <script src="js/ui-load.js"></script>
    <script src="js/ui-jp.config.js"></script>
    <script src="js/ui-jp.js"></script>
    <script src="js/ui-nav.js"></script>
    <script src="js/ui-toggle.js"></script>
    <script src="js/ui-client.js"></script>

    <script src="js/jquery.bootstrap.newsbox.min.js" type="text/javascript"></script>
    <script src="js/jquery.seat-charts.min.js" type="text/javascript"></script>
    <script src="js/common.js" type="text/javascript"></script>
    <script>
        var sc;
        var riqi = getUrlParamater("date");
        var sysid = getUrlParamater("sysid");
        var zuoweiObjs = [];
        var bukeyongOption = [];
        $(function () {
            getShiYanShis();
            $("#user").text(loginuser.id);
            $("#name").text(loginuser.name);
            var d = new Date(riqi);
            $("#riqi").text(riqi.substr(5, 5));
            $("#riqizhou").text(xingqi[d.getDay() - 1]);
            setShiYanShiMing();
            getZwoWeiByShiYahShi(sysid);

            getBuKeYongShiJianByShiYanShi(sysid);
            setBuKeYongShiJan();

            $("#tijiao").click(tiJiaoYuYue);
            $("#kaishi").change(kaishiChange);
            $("#jieshu").change(setYiYuYueZuoWei);
            getYuYue(-1, sysid);
            setYiYuYueZuoWei();
            kaishiChange();
        });

        function kaishiChange() {
            $("#jieshu option").each(function () {
                if ($(this).val().replace(":", '') <= $("#kaishi").val().replace(":", '')) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            }, this);
            $("#jieshu option").each(function () {
                if ($(this).css('display') == 'block') {
                    $("#jieshu").val($(this).val());
                    setYiYuYueZuoWei();
                    return false;

                }
            }, this);
        }

        function tiJiaoYuYue() {
            var kaishiSelected = $("#kaishi").val();
            var jieshuSelected = $("#jieshu").val();
            var d = new Date(riqi);
            var bukeyong = BuKeYongShiJianS.find(b => b.zhouji == d.getDay());
            if (bukeyong) {
                var kaishiY = bukeyong.kaishiriqi;
                var jieshuY = bukeyong.jieshuriqi;
                if (
                    ((kaishiY <= kaishiSelected && kaishiSelected < jieshuY) ||
                        (kaishiY < jieshuSelected && jieshuSelected <= jieshuY) ||
                        (kaishiY > kaishiSelected && jieshuY < jieshuSelected))
                ) {
                    alert('包含不可用时间段。')
                    return false;
                }
            }
            if (jieshuSelected.replace(':', '') - kaishiSelected.replace(':', '') > 400 ||
                jieshuSelected.replace(':', '') - kaishiSelected.replace(':', '') < 100) {
                alert('时长超出允许范围。')
                return false;
            }


            // for (var i = 0; i < bukeyongOption.length; i++) {
            //   var temp = $(bukeyongOption[i]).val().replace(':', '');
            //   if (kaishiSelected <= temp && temp <= jieshuSelected) {
            //     alert('包含不可用时间段。')
            //     return false;
            //   }
            // }
            if (sc.find('selected').seatIds.length == 0) {
                alert('请选择座位。');
                return;
            }
            var selectedId = sc.find('selected').seatIds[0];
            var zuowei = zuoweiObjs[selectedId.split('_')[0]][selectedId.split('_')[1] - 1];
            var yuyue = {
                xueshengbianhao: loginuser.id,
                yuyuekaishiriqi: riqi + ' ' + $('#kaishi').val(),
                yuyuejieshuriqi: riqi + ' ' + $('#jieshu').val(),
                gengxinriqi: new Date().toString().substr(0, 24)
            };
            $.ajax({
                type: "post",
                url: apiUrl + 'T_YuYue/?shiyanshihao=' + sysid + '&zuoweihao=' + zuowei.zidongbianhao,
                data: yuyue,
                dataType: "json",
                error: function (err) {
                    console.log(err);
                },
                complete: function () {
                    alert('预定成功！')
                    window.location.href = './preview.html?sysid=' + sysid;
                }
            });
        }

        function setShiYanShiMing() {
            setTimeout(function () {
                if (ShiYanShiS.length > 0) {
                    $("#shiyanshi").text(ShiYanShiS.find(s => s.zidongbianhao == getUrlParamater("sysid")).mingzi);
                } else {
                    setShiYanShiMing();
                }
            }, 300);
        }

        function getZwoWeiByShiYahShi(sysid) {
            if (sysid) {
                var max = 0;
                $('#zuoweiTable').html('');
                $.ajax({
                    type: "get",
                    url: apiUrl + 'M_ZuoWei?shiyanshihao=' + sysid,
                    dataType: "json",
                    success: function (response) {
                        if (response) {
                            var preZhaohao;
                            response.forEach(function (z) {

                                if (!preZhaohao) {
                                    preZhaohao = z.zhuohao;
                                }
                                if (preZhaohao == z.zhuohao) {
                                    if (!zuoweiObjs[z.zhuohao]) {
                                        zuoweiObjs[z.zhuohao] = [z];
                                    } else {
                                        zuoweiObjs[z.zhuohao].push(z);
                                    }
                                } else {
                                    preZhaohao = z.zhuohao;
                                    zuoweiObjs[z.zhuohao] = [z];
                                }
                                max = zuoweiObjs[z.zhuohao].length > max ? zuoweiObjs[z.zhuohao].length : max;
                                // if (zuoweiObjs[z.zhuohao]) {
                                //   zuoweiObjs[z.zhuohao] = [z];
                                // } else {
                                //   zuoweiObjs[z.zhuohao].push(z);
                                // }

                                //$('#zuoweiTable').append(' <tr><td>' + z.zidongbianhao + '</td><td>' + z.zuoweimingcheng + '</td><td>' + z.zhuohao + '</td><td><a href="javascript:ShanChuan(' + z.zidongbianhao + ')" >删除</a></td></tr>')
                            }, this);
                            var setMapArr = [];
                            var rowArr = [];
                            zuoweiObjs.forEach(function (zhuo, index) {
                                if (zhuo) {
                                    rowArr.push(index);
                                    var zhuoTemp = '';
                                    for (var i = 0; i < max; i++) {
                                        var z = zhuo[i];
                                        if (z) {

                                            zhuoTemp += 'a';
                                        } else {
                                            zhuoTemp += '_'
                                        }
                                    }
                                    setMapArr.push(zhuoTemp);
                                }
                            }, this);
                            setMap(setMapArr, rowArr);
                        }
                    }
                });
            }
        }

        function setMap(setMapArr, rowArr) {
            sc = $('#seat-map').seatCharts({
                map: setMapArr,

                seats: {
                    a: {
                        price: 99.99,
                        classes: 'front-seat' //your custom CSS class
                    }

                },
                naming: {
                    top: false,
                    // getLabel : function (character, row, column) {
                    // 	return column;
                    // },
                    rows: rowArr,
                },
                legend: {
                    node: $('#my-legend-container'),
                    items: [
                        ['a', 'available', '可选座位'],
                        ['a', 'selected', '已选座位'],
                        ['a', 'unavailable', '不可选座位']
                    ]
                },
                click: function () {
                    if (this.status() == 'available') {
                        //do some stuff, i.e. add to the cart
                        if (sc.find('selected').seatIds.length == 1) {
                            alert('只能选择一个座位。')
                            return this.style();
                        }
                        return 'selected';
                    } else if (this.status() == 'selected') {
                        //seat has been vacated
                        return 'available';
                    } else if (this.status() == 'unavailable') {
                        //seat has been already booked
                        return 'unavailable';
                    } else {
                        return this.style();
                    }
                }
            });

            // //Make all available 'c' seats unavailable
            sc.find('b.available').status('unavailable');

            // /*
            // Get seats with ids 2_6, 1_7 (more on ids later on),
            // put them in a jQuery set and change some css
            // */
            // sc.get(['2_6', '1_7']).node().css({
            //   color: '#ffcfcf'
            // });

            // console.log('Seat 1_2 costs ' + sc.get('1_2').data().price + ' and is currently ' + sc.status('1_2'));
        }

        function setBuKeYongShiJan() {
            setTimeout(function () {
                if (BuKeYongShiJianS.length > 0) {
                    //$("#shiyanshi").text(ShiYanShiS.find(s => s.zidongbianhao == getUrlParamater("sysid")).mingzi);
                    var d = new Date(riqi);
                    var bukeyong = BuKeYongShiJianS.find(b => b.zhouji == d.getDay());
                    if (bukeyong) {
                        $("#bukeyong").text(bukeyong.kaishiriqi + ' - ' + bukeyong.jieshuriqi);
                        var kaishi = bukeyong.kaishiriqi.replace(':', '');
                        var jieshu = bukeyong.jieshuriqi.replace(':', '');
                        $("#kaishi option").each(function (i, o) {
                            var tmp = $(o).val().replace(':', '');
                            if (kaishi <= tmp && tmp < jieshu) {
                                bukeyongOption.push(o);
                                $(o).remove();
                            }
                        });
                        $("#jieshu option").each(function (i, o) {
                            var tmp = $(o).val().replace(':', '');
                            if (kaishi < tmp && tmp <= jieshu) {
                                bukeyongOption.push(o);
                                $(o).remove();
                            }
                        });
                    } else {
                        $("#bukeyong").text('无');
                    }
                    $("#jieshu").val($("#jieshu option:eq(2)").val());
                    $("#jieshu").change();

                } else {
                    setBuKeYongShiJan();
                }
            }, 300);
        }

        function setYiYuYueZuoWei() {
            setTimeout(function () {
                if (YuYueS.length > 0) {
                    if (sc.find('selected').length) {
                        sc.find('selected').seats[0].status('available');
                    }
                    if (sc.find('unavailable').length) {
                        sc.find('unavailable').each(function () {
                            this.status('available');
                        })
                    }
                    YuYueS.forEach(function (y) {
                        for (var i = 0; i < zuoweiObjs.length; i++) {
                            var zhuo = zuoweiObjs[i];
                            if (zhuo) {
                                for (var j = 0; j < zhuo.length; j++) {
                                    var zuowei = zhuo[j];
                                    y.kaishi
                                    if (zuowei.zidongbianhao == y.zuoweihao && y.kaishi.substr(0, 10) == riqi) {
                                        var kaishiSelected = $("#kaishi").val().replace(':', '');
                                        var jieshuSelected = $("#jieshu").val().replace(':', '');
                                        var kaishiY = y.kaishi.substr(11, 5).replace(':', '');
                                        var jieshuY = y.jieshu.substr(11, 5).replace(':', '');
                                        console.log(kaishiSelected + '<' + kaishiY + '&&<' + jieshuY + '<' + jieshuSelected);
                                        if (
                                            (kaishiY <= kaishiSelected && kaishiSelected < jieshuY) ||
                                            (kaishiY < jieshuSelected && jieshuSelected <= jieshuY)
                                        ) {
                                            sc.get(i + '_' + (j + 1)).status('unavailable');
                                        }
                                        //sc.get(i + '_' + (j + 1)).status('unavailable');

                                    }
                                }
                            }
                        }
                    });

                } else {
                    setYiYuYueZuoWei();
                }
            }, 300);
        }
    </script>



</body>

</html>